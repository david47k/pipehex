(()=>{"use strict";function t(t,e){return e instanceof Map?{dataType:"Map",val:Array.from(e.entries())}:e}function e(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.val):e}const i={save:function(t,e){localStorage.setItem("phex_"+t,e)},saveInt:function(t,e){this.save(t,e)},saveStr:function(t,e){this.save(t,e)},saveMap:function(e,i){localStorage.setItem("phex_"+e,JSON.stringify(i,t))},loadMap:function(t,i){var s=localStorage.getItem("phex_"+t);return null==s?i:JSON.parse(s,e)},loadInt:function(t,e){var i=parseInt(localStorage.getItem("phex_"+t));return isNaN(i)?e:i},loadStr:function(t,e){let i=localStorage.getItem("phex_"+t);return null==i?e:i},saveObj:function(t,e){localStorage.setItem("phex_"+t,JSON.stringify(e))},loadObj:function(t,e){var i=localStorage.getItem("phex_"+t);return null==i?e:JSON.parse(i)}},s=["#bbbbbb","#f51a3c","#a92393","#623297","#0060b3","#0078c5","#02b2b5","#24bb4e","#add73c","#ffdd00","#ffc110","#fc9b1e","#f97625"];class n{constructor(t,e){this.gameWidth=t,this.gameHeight=e,this.container=document.getElementById("container"),this.drawMethod=1,this.alwaysRenderAll=0,this.canvasCache=new Map,this.unitOnScreenH=64,this.unitOnScreenVO=48,this.unitOnScreenW=56,this.setUp(t,e)}setUp(t,e){console.log("setting up...");let{width:i,height:s}=this.container.getBoundingClientRect();s=document.documentElement.clientHeight-15,64!=this.srcBlockH&&(this.srcBlockH=64,this.srcBlockW=56);const[n]=this.container.children;n&&this.container.removeChild(n);const r=document.createElement("canvas");this.container.appendChild(r),this.context=r.getContext("2d"),r.setAttribute("width",""+(t*this.unitOnScreenW+Math.floor(this.unitOnScreenW/2))),r.setAttribute("height",""+((e+1)*this.unitOnScreenVO-this.unitOnScreenH/2)),this.renderStats()}renderImg(t,e,i,s){}renderFromCanvas(t,e,i){i%2==1&&(e+=.5),this.context&&this.context.drawImage(t,0,0,this.unitOnScreenW,this.unitOnScreenH,Math.floor(this.unitOnScreenW*e),this.unitOnScreenVO*i,this.unitOnScreenW,this.unitOnScreenH)}getHexCanvas(t=13){const e=t+65536;if(this.canvasCache.has(e))return this.canvasCache.get(e);let i=document.createElement("canvas"),n=i.getContext("2d"),r=this.unitOnScreenW,a=this.unitOnScreenH;return i.setAttribute("width",r.toString()),i.setAttribute("height",a.toString()),n.clearRect(0,0,r,a),n.fillStyle=13==t?"#333333":14==t?"#555555":s[t],n.strokeStyle="#000000",n.lineWidth=1,n.beginPath(),n.moveTo(r/2,0),n.lineTo(r,a/4),n.lineTo(r,3*a/4),n.lineTo(r/2,a),n.lineTo(0,3*a/4),n.lineTo(0,a/4),n.lineTo(r/2,0),n.fill(),n.stroke(),this.canvasCache.set(e,i),i}getLineCanvas(t,e){let i=0;for(let e=0;e<6;e++)t[e]&&(i|=1<<e);if(i|=e<<6,this.canvasCache.has(i))return this.canvasCache.get(i);let n=document.createElement("canvas"),r=n.getContext("2d"),a=this.unitOnScreenW,l=this.unitOnScreenH;n.setAttribute("width",a.toString()),n.setAttribute("height",l.toString()),r.lineCap="butt",r.lineJoin="bevel",r.clearRect(0,0,a,l),r.fillStyle=s[e],r.strokeStyle=s[e],r.lineWidth=l/8;let o=0;for(let e=0;e<t.length;e++){if(!t[e])continue;o++,r.beginPath(),r.moveTo(a/2,l/2);let i=a/2,s=l/2;0==e?i=a:1==e?(s=7*l/8,i=3*a/4):2==e?(s=7*l/8,i=1*a/4):3==e?i=0:4==e?(s=1*l/8,i=1*a/4):5==e&&(s=1*l/8,i=3*a/4),r.lineTo(i,s),r.stroke()}let h=l/16;return 1==o&&(h=l/8),r.beginPath(),r.moveTo(a/2,l/2),r.arc(a/2,l/2,h,0,2*Math.PI,!0),r.fill(),this.canvasCache.set(i,n),n}renderStats(){if(p&&p.stats){const t=p.stats;document.getElementById("stats_size").innerHTML=t.puztype,document.getElementById("stats_num").innerHTML=t.num,document.getElementById("stats_best").innerHTML=t.best,document.getElementById("stats_best3").innerHTML=t.best3,document.getElementById("stats_best5").innerHTML=t.best5,document.getElementById("stats_best10").innerHTML=t.best10}}render(){let t=p;if(!t)return void console.log("view::render() called with no gamemanager initialised");if(!this.context)return;let e=p.game,i=p.game.ts;(this.alwaysRenderAll||t.game.winningAnimation.started)&&t.paintAll();for(const s of t.renderSet){const[n,r]=t.game.xy_from_idx(s);if(0==this.drawMethod)this.renderImg(n,r,0,0),this.renderImg(n,r,e.grid[r][n].angle,e.grid[r][n].shape);else if(1==this.drawMethod){let a=null;if(t.game.winningAnimation.started){let e=Math.floor((i-t.game.winningAnimation.start_ts)/100)+n;e=1+Math.floor(e)%11,a=this.getHexCanvas(e)}else a=t.loopedSet.has(s)?this.getHexCanvas(14):this.getHexCanvas();this.renderFromCanvas(a,n,r);let l=t.game.grid[r][n].color,o=this.getLineCanvas(e.grid[r][n].conns,l);this.renderFromCanvas(o,n,r)}}if(t.renderSet.clear(),p.showFPS){let t=Math.floor(1e3/(i-e.last_ts));document.getElementById("fps_text").innerHTML=""+t}e.last_ts=i,document.getElementById("puzzle_title").innerHTML=e.title,document.getElementById("timer_text").innerHTML=e.timer.timestring(),e.won?(document.getElementById("wintime").innerHTML=e.wintime,document.getElementById("winner").classList.remove("hide"),this.renderStats()):document.getElementById("winner").classList.add("hide");const s=!p.game.timer.running;document.getElementById("pause").setAttribute("aria-pressed",s.toString())}}const r=[[0,0,0,0,0,0],[1,0,0,0,0,0],[1,1,0,0,0,0],[1,0,1,0,0,0],[1,0,0,1,0,0],[1,1,1,0,0,0],[1,0,1,1,0,0],[1,0,0,1,1,0],[1,0,1,0,1,0],[1,1,1,1,0,0],[1,0,1,1,1,0],[1,1,0,1,1,0],[1,1,1,1,1,0],[1,1,1,1,1,1]];function a(t,e){return Array.isArray(t)&&Array.isArray(e)?t.length===e.length&&t.every(((t,i)=>a(t,e[i]))):t===e}function l(t,e){for(var i=e,s=0;s<6;s++){if(a(i,t))return{m:!0,a:s};i=[i[5],i[0],i[1],i[2],i[3],i[4]]}return{m:!1,a:0}}function o(t){let e=0,i=0,s=0;for(let n=0;n<6;n++)1==t[n]&&(e++,s||(i=n,s=1));let n=0;if(1==e)n=1;else if(e>=2&&e<=5)for(let e=2;e<=12;e++){const s=l(t,r[e]);if(1==s.m){n=e,i=s.a;break}}else 6==e&&(n=13);return{s:n,a:i}}function h(t){let e=Math.trunc(t/1e3);const i=Math.trunc(e/60);e-=60*i;let s=e.toString();return s.length<2&&(s="0"+s),i.toString()+":"+s}class u{constructor({time:t=0}={}){this.time=t,this.timestamp=0,this.running=!1}start(t){this.running?this.update(t):(this.timestamp=t,this.running=!0)}stop(t){this.running&&(this.update(t),this.running=!1)}reset(){this.running=!1,this.time=0}set_millis(t){this.time=t}update(t){if(this.running){const e=t-this.timestamp;e>=0?this.time+=e:console.log("time has gone backwards"),this.timestamp=t}}get_millis(){return this.time}timestring(){return h(this.time)}}class d{constructor({conns:t=[c(),c(),c(),c(),c(),c()],color:e=0,isolated:i=!0,locked:s=!1,looped:n=!1}={}){this.conns=t;let r=o(this.conns);this.shape=r.s,this.angle=r.a,this.color=e,this.isolated=i,this.locked=s,this.looped=n}rotate_cw(){this.conns=[this.conns[5],this.conns[0],this.conns[1],this.conns[2],this.conns[3],this.conns[4]],this.angle++,6==this.angle&&(this.angle=0),(4==this.shape&&3==this.angle||8==this.shape&&2==this.angle||11==this.shape&&3==this.angle||13==this.shape)&&(this.angle=0)}rotate_ccw(){this.conns=[this.conns[1],this.conns[2],this.conns[3],this.conns[4],this.conns[5],this.conns[0]],this.angle--,-1==this.angle&&(4==this.shape?this.angle=2:8==this.shape?this.angle=1:11==this.shape?this.angle=2:13==this.shape?this.angle=0:this.angle=5)}setup(t){this.conns=t;const e=o(this.conns);this.shape=e.s,this.angle=e.a}equal(t){this.conns.every(((e,i)=>e==t.conns[i]))}}function c(){return Math.trunc(2*Math.random())}class g{constructor(t={}){this.puzzle_w=0,this.puzzle_h=0,this.grid=null,this.sol_grid=null,this.won=!1,this.title="(puzzle title)",this.timer=new u,this.wintime="";for(const[e,i]of Object.entries(t))t.hasOwnProperty(e)&&Object.defineProperty(this,e,{value:Object.getOwnPropertyDescriptor(t,e).value,writable:!0});this.grid=this.new_game_grid(this.grid),this.timer=new u(this.timer),this.tile_w=56,this.tile_h=64,this.tile_vo=3*this.tile_h/4,this.last_ts=0,this.ts=0,this.winningAnimation={started:!1,start_ts:0}}tile_from_idx(t){let e=~~(t/this.puzzle_w),i=t%this.puzzle_w;return this.grid[e][i]}xy_from_idx(t){let e=~~(t/this.puzzle_w);return[t%this.puzzle_w,e]}idx_from_xy(t,e){return e*this.puzzle_w+t}new_game_grid(t=null){let e=[];for(let i=0;i<this.puzzle_h;i++){let s=[];for(let e=0;e<this.puzzle_w;e++)null==t?s.push(new d):s.push(new d(t[i][e]));e.push(s)}return e}new_game_grid_from_puzstr(t){let e=this.new_game_grid(),i=t.split("");for(let t=0;t<this.puzzle_h;t++)for(let s=0;s<this.puzzle_w;s++){let n=[0,0,0,0,0,0],r=i[t*this.puzzle_w+s],a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-".indexOf(r);1==(1&a)&&(n[0]=1),2==(2&a)&&(n[1]=1),4==(4&a)&&(n[2]=1),8==(8&a)&&(n[3]=1),16==(16&a)&&(n[4]=1),32==(32&a)&&(n[5]=1),e[t][s].setup(n)}return e}have_win_condition(){if(!Array.isArray(this.sol_grid))return!1;for(let t=0;t<this.puzzle_h;t++)for(let e=0;e<this.puzzle_w;e++)if(!a(this.grid[t][e].conns,this.sol_grid[t][e].conns))return!1;return this.won=!0,!0}pause(t){return this.timer.running?(this.timer.stop(t),!0):(this.timer.start(t),!1)}load_level_string(t){let[e,i,s,n,r]=t.split(",");this.title=e,this.puzzle_w=parseInt(i),this.puzzle_h=parseInt(s),this.grid=this.new_game_grid_from_puzstr(n),this.sol_grid=this.new_game_grid_from_puzstr(r)}pixel_xy_to_grid_xy(t,e){let i=Math.floor(e/this.tile_vo),s=e%this.tile_vo/this.tile_vo,n=0;i%2==1&&(n=this.tile_w/2);let r=Math.floor((t-n)/this.tile_w),a=(t-n)%this.tile_w/this.tile_w;if(s<1/3){let t=3*s;a<.5?2*a<1-t&&(i%2==0&&(r-=1),i-=1):2*(a-.5)>t&&(i%2==0&&(r-=1),i-=1,r+=1)}return[r,i]}inBounds(t,e){return t>=0&&t<this.puzzle_w&&e>=0&&e<this.puzzle_h}invertAngle(t){return t>2?t-3:t+3}get_gxy_at_angle(t,e,i){let s=t,n=e;return 0==i?s++:1==i?(e%2==0||s++,n++):2==i?e%2==0?(s--,n++):n++:3==i?s--:4==i?e%2==0?(s--,n--):n--:5==i&&(e%2==0||s++,n--),s<0||s>this.puzzle_w-1||n<0||n>this.puzzle_h-1?null:[s,n]}is_isolated(t,e){for(let i=0;i<6;i++){if(!this.grid[e][t].conns[i])continue;let s=this.get_gxy_at_angle(t,e,i);if(null==s)continue;let[n,r]=s;if(this.grid[r][n].conns[this.invertAngle(i)])return!1}return!0}get_surrounding_tiles(t,e){let i=[];for(let s=0;s<6;s++){let n=this.get_gxy_at_angle(t,e,s);if(null==n)continue;let[r,a]=n;i.push([r,a])}return i}get_connected_tiles(t,e,i){class s{constructor(t,e,i,s){this.x=t,this.y=e,this.fromangle=i,this.angle=s}}let n=[new s(t,e,null,0)],r=new Set;r.add(e*this.puzzle_w+t);let a=new Set;for(;n.length>0;){let t=n.pop(),e=t.x,l=t.y,o=t.fromangle,h=t.angle;if(h>5)continue;if(n.push(new s(e,l,o,h+1)),null!=o&&o==h)continue;if(!this.grid[l][e].conns[h])continue;let u=this.get_gxy_at_angle(e,l,h);if(null==u)continue;let[d,c]=u;if(this.grid[c][d].conns[this.invertAngle(h)])if(r.has(c*this.puzzle_w+d)){let t=0;for(t=0;t<n.length&&(n[t].x!=d||n[t].y!=c);t++);if(t==n.length);else for(let e=t;e<n.length;e++)a.add(n[e].y*this.puzzle_w+n[e].x)}else r.add(c*this.puzzle_w+d),i&&n.push(new s(d,c,this.invertAngle(h),0))}return[r,a]}}function m(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="text",i.onload=function(s){const n=i.response;console.log("puzzle file loaded: ",t);let r=[],a=n.split("\n");for(let t of a)t.length>8&&r.push(t);e(r)},i.send(null)}var p=new class{constructor(){this.PUZZLES=new Map,this.puzzle_type=i.loadStr("puzzle_type","5"),this.puzzle_idx=i.loadInt("puzzle_idx"+this.puzzle_type,0),this.showStats=!1,this.showFPS=!1,this.showTimer=!0,m("/puzzles5.csv",(t=>this.PUZZLES.set("5",t))),m("/puzzles10.csv",(t=>this.PUZZLES.set("10",t))),m("/puzzles15.csv",(t=>this.PUZZLES.set("15",t))),m("/puzzles20.csv",(t=>this.PUZZLES.set("20",t))),m("/puzzles30.csv",(t=>this.PUZZLES.set("30",t))),m("/puzzles40.csv",(t=>this.PUZZLES.set("40",t))),this.renderSet=new Set,this.loopedSet=new Set,this.game=this.loadGame(parseInt(this.puzzle_type)),this.updateStats(),this.view=new n(this.game.puzzle_w,this.game.puzzle_h),this.restart({restart_solved:!1,restart_game:!1}),this.view.container.addEventListener("contextmenu",(function(t){return t.preventDefault(),!1})),this.view.container.addEventListener("click",(function(t){return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1})),this.view.container.addEventListener("mouseup",(function(t){return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1})),this.view.container.addEventListener("mousedown",(function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();var e=p,[i,s]=e.game.pixel_xy_to_grid_xy(t.offsetX,t.offsetY);return e.game.inBounds(i,s)&&e.click(i,s,t.buttons),!1}))}prev_puzzle(){this.puzzle_idx<=0?console.log("No previous puzzles!"):(this.puzzle_idx--,i.saveInt("puzzle_idx"+this.puzzle_type,this.puzzle_idx),this.restart())}next_puzzle(){this.puzzle_idx+1>=this.PUZZLES.get(this.puzzle_type).length?console.log("Ran out of puzzles!"):(this.puzzle_idx++,i.saveInt("puzzle_idx"+this.puzzle_type,this.puzzle_idx),this.restart())}restart({restart_solved:t=!1,restart_game:e=!0}={}){if(this.PUZZLES.has(this.puzzle_type)){if(e||0==this.game.puzzle_w){const t=parseInt(this.puzzle_type);this.game=new g({puzzle_w:t,puzzle_h:t}),this.game.load_level_string(this.PUZZLES.get(this.puzzle_type)[this.puzzle_idx])}if(!t){let t=i.loadMap("highscore_"+this.puzzle_type,new Map),e=parseInt(t.get(this.puzzle_idx));Number.isInteger(e)&&(this.game.grid=this.game.sol_grid,this.game.timer=new u({time:e}),this.game.have_win_condition()&&this.on_win())}this.view&&(this.view.setUp(this.game.puzzle_w,this.game.puzzle_h),this.paintAll()),this.saveGame()}else setTimeout((()=>p.restart({restart_solved:t,restart_game:e})),100)}setSize(t){this.puzzle_type=t.toString(),i.saveStr("puzzle_type",this.puzzle_type),this.puzzle_idx=i.loadInt("puzzle_idx"+this.puzzle_type,0),this.updateStats(),this.restart()}updateLoopSet(){const t=this.loopedSet;this.loopedSet=new Set;let e=[];for(let t=0;t<this.game.puzzle_h*this.game.puzzle_w;t++)e.push(t);for(;e.length>0;){let t=e.pop();if(-1==t)continue;let[i,s]=this.game.xy_from_idx(t),[n,r]=this.game.get_connected_tiles(i,s,!0);for(const t of n){let i=e.findIndex((e=>e===t));-1!=i&&(e[i]=-1)}for(const t of r)this.loopedSet.add(t)}for(const e of t)this.loopedSet.has(e)||this.renderSet.add(e);for(const e of this.loopedSet)t.has(e)||this.renderSet.add(e)}render(t){this.game.ts=t,this.game.timer.update(t),this.renderSet.size>0&&this.updateLoopSet(),this.view.render()}paintAll(){this.renderSet=new Set,this.loopedSet=new Set,this.updateLoopSet();for(let t=0;t<this.game.puzzle_h*this.game.puzzle_w;t++)this.renderSet.add(t)}saveGame(){i.saveObj("savegame",this.game)}loadGame(t){let e=i.loadObj("savegame",{puzzle_w:0,puzzle_h:0});return new g(e)}updateStats(){let t=[...i.loadMap("highscore_"+this.puzzle_type,new Map).values()];t.sort(((t,e)=>t-e));let e=this.puzzle_type+"x"+this.puzzle_type,s="tbd",n="tbd",r="tbd",a="tbd";t.length>=1&&(s=h(t[0])),t.length>=3&&(n=h(t.slice(0,3).reduce(((t,e)=>t+e),0)/3)),t.length>=5&&(r=h(t.slice(0,5).reduce(((t,e)=>t+e),0)/5)),t.length>=10&&(a=h(t.slice(0,10).reduce(((t,e)=>t+e),0)/10)),this.stats={puztype:e,num:t.length.toString(),best:s,best3:n,best5:r,best10:a}}on_win(){this.game.timer.stop(this.game.last_ts),this.game.wintime=this.game.timer.timestring(),document.getElementById("wintime").innerHTML=this.game.wintime;let t=i.loadMap("highscore_"+this.puzzle_type,new Map);t.set(this.puzzle_idx,Math.trunc(this.game.timer.get_millis())),i.saveMap("highscore_"+this.puzzle_type,t),this.updateStats(),0==this.game.winningAnimation.started&&(this.game.winningAnimation.started=!0,this.game.winningAnimation.start_ts=this.game.ts)}click(t,e,i){if(!this.game.won){0==i||1==i?this.game.grid[e][t].rotate_cw():2==i&&this.game.grid[e][t].rotate_ccw(),this.renderSet.add(this.game.idx_from_xy(t,e)),this.game.timer.start(this.game.last_ts);let s=this.game.get_surrounding_tiles(t,e);for(;s.length>0;){let[t,e]=s.pop();this.game.is_isolated(t,e)?0==this.game.grid[e][t].isolated&&(this.game.grid[e][t].isolated=!0,this.game.grid[e][t].color=0,this.renderSet.add(this.game.idx_from_xy(t,e))):1==this.game.grid[e][t].isolated&&(this.renderSet.add(this.game.idx_from_xy(t,e)),this.game.grid[e][t].isolated=!1)}let[n,r]=this.game.get_connected_tiles(t,e,!0),a=this.game.grid[e][t].color;if(n.size<=1)this.game.grid[e][t].isolated=!0,a=0;else{this.game.grid[e][t].isolated=!1;let i=n.values();i.next();let s=i.next().value;a=this.game.tile_from_idx(s).color,0==a&&(a=1+(e*this.game.puzzle_w+t)%12)}for(let t of n){let e=Math.trunc(t/this.game.puzzle_w),i=t%this.game.puzzle_w;this.game.grid[e][i].color!=a&&(this.game.grid[e][i].color=a,this.renderSet.add(t))}this.game.have_win_condition()&&this.on_win()}this.render(this.game.ts),this.saveGame()}};document.getElementById("restart_button").addEventListener("click",(function(){p.restart({restart_solved:!0})})),document.getElementById("prev_puzzle").addEventListener("click",(function(){p.prev_puzzle()}));let _=document.getElementsByClassName("next_puzzle");for(let t=0;t<_.length;t++)_.item(t).addEventListener("click",(function(){p.next_puzzle()}));document.getElementById("pause").addEventListener("click",(function(t){const e=p.game.pause(p.game.last_ts),i=t.target;i instanceof HTMLInputElement&&i.setAttribute("aria-pressed",e.toString())})),document.getElementById("show_fps").addEventListener("click",(function(t){const e=!p.showFPS;let i=document.getElementById("menu_fps");p.showFPS=e;const s=t.target;s instanceof HTMLInputElement&&s.setAttribute("aria-pressed",e.toString()),e?i.classList.remove("hide"):i.classList.add("hide")})),document.getElementById("show_timer").addEventListener("click",(function(t){const e=!p.showTimer,i=document.getElementById("menu_time");p.showTimer=e;const s=t.target;s instanceof HTMLInputElement&&s.setAttribute("aria-pressed",e.toString()),e?i.classList.remove("hide"):i.classList.add("hide")})),document.getElementById("settings_button").addEventListener("click",(function(t){const e=t.target;if(e instanceof HTMLInputElement){const t="true"===e.getAttribute("aria-pressed");e.setAttribute("aria-pressed",(!t).toString())}let i=document.getElementById("settings_menu");i.classList.contains("hide")?i.classList.remove("hide"):i.classList.add("hide")})),document.getElementById("stats_button").addEventListener("click",(function(t){let e=document.getElementById("stats");const i=t.target;0==p.showStats?(p.updateStats(),p.showStats=!0,e.classList.remove("hide"),i instanceof HTMLInputElement&&i.setAttribute("aria-pressed","true")):(p.showStats=!1,e.classList.add("hide"),i instanceof HTMLInputElement&&i.setAttribute("aria-pressed","false"))}));let z=document.getElementById("settings_game_size");Array.prototype.forEach.call(z.children,(t=>{t.addEventListener("click",(function(e){const i=Number.parseInt(t.getAttribute("data"));p.setSize(i)}))})),function t(e){window.requestAnimationFrame(t),p.render(e)}(0)})();