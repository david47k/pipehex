(()=>{"use strict";function t(e,i){return Array.isArray(e)&&Array.isArray(i)?e.length===i.length&&e.every(((e,s)=>t(e,i[s]))):e===i}function e(){return Math.trunc(2*Math.random())}const i=[[0,0,0,0,0,0],[1,0,0,0,0,0],[1,1,0,0,0,0],[1,0,1,0,0,0],[1,0,0,1,0,0],[1,1,1,0,0,0],[1,0,1,1,0,0],[1,0,0,1,1,0],[1,0,1,0,1,0],[1,1,1,1,0,0],[1,0,1,1,1,0],[1,1,0,1,1,0],[1,1,1,1,1,0],[1,1,1,1,1,1]];function s(e,i){for(var s=i,n=0;n<6;n++){if(t(s,e))return{m:!0,a:n};s=[s[5],s[0],s[1],s[2],s[3],s[4]]}return{m:!1,a:0}}function n(t){let e=0,n=0,r=0;for(let i=0;i<6;i++)1==t[i]&&(e++,r||(n=i,r=1));let h=0;if(1==e)h=1;else if(e>=2&&e<=5)for(let e=2;e<=12;e++){const r=s(t,i[e]);if(1==r.m){h=e,n=r.a;break}}else 6==e&&(h=13);return{s:h,a:n}}class r{constructor({conns:t=[e(),e(),e(),e(),e(),e()],color:i=u,isolated:s=!0,locked:r=!1,looped:h=!1}={}){this.conns=t;let a=n(this.conns);this.shape=a.s,this.angle=a.a,this.color=i,this.isolated=s,this.locked=r,this.looped=h}rotate(t=!1){t?(this.conns=[this.conns[1],this.conns[2],this.conns[3],this.conns[4],this.conns[5],this.conns[0]],this.angle--,-1==this.angle&&(4==this.shape?this.angle=2:8==this.shape?this.angle=1:11==this.shape?this.angle=2:13==this.shape?this.angle=0:this.angle=5)):(this.conns=[this.conns[5],this.conns[0],this.conns[1],this.conns[2],this.conns[3],this.conns[4]],this.angle++,6==this.angle&&(this.angle=0),(4==this.shape&&3==this.angle||8==this.shape&&2==this.angle||11==this.shape&&3==this.angle||13==this.shape)&&(this.angle=0))}setup(t){this.conns=t;const e=n(this.conns);this.shape=e.s,this.angle=e.a}equal(t){this.conns.every(((e,i)=>e==t.conns[i]))}}function h(t){let e=Math.trunc(t/1e3);const i=Math.trunc(e/60);e-=60*i;let s=e.toString();return s.length<2&&(s="0"+s),i.toString()+":"+s}class a{constructor({time:t=0}={}){this.time=t,this.timestamp=0,this.running=!1}start(t){this.running?this.update(t):(this.timestamp=t,this.running=!0)}stop(t){this.running&&(this.update(t),this.running=!1)}reset(){this.running=!1,this.time=0}update(t){if(this.running){const e=t-this.timestamp;e>=0?this.time+=e:console.log("time has gone backwards"),this.timestamp=t}}getMillis(){return this.time}timestring(){return h(this.time)}}class o{constructor(t={}){this.width=0,this.height=0,this.grid=null,this.solvedGrid=null,this.won=!1,this.title="(puzzle title)",this.timer=new a,this.wintime="";for(const[e,i]of Object.entries(t))t.hasOwnProperty(e)&&Object.defineProperty(this,e,{value:Object.getOwnPropertyDescriptor(t,e).value,writable:!0});this.grid=this.newGrid(this.grid),this.timer=new a(this.timer),this.tileW=56,this.tileH=64,this.tileVO=3*this.tileH/4,this.tsPrior=0,this.ts=0,this.winningAnimation={started:!1,start_ts:0}}tileFromIdx(t){let e=~~(t/this.width),i=t%this.width;return this.grid[e][i]}xyFromIdx(t){let e=~~(t/this.width);return[t%this.width,e]}idxFromXy(t,e){return e*this.width+t}newGrid(t=null){let e=[];for(let i=0;i<this.height;i++){let s=[];for(let e=0;e<this.width;e++)null==t?s.push(new r):s.push(new r(t[i][e]));e.push(s)}return e}newGridFromPuzstr(t){let e=this.newGrid(),i=t.split("");for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){let n=[0,0,0,0,0,0],r=i[t*this.width+s],h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-".indexOf(r);1==(1&h)&&(n[0]=1),2==(2&h)&&(n[1]=1),4==(4&h)&&(n[2]=1),8==(8&h)&&(n[3]=1),16==(16&h)&&(n[4]=1),32==(32&h)&&(n[5]=1),e[t][s].setup(n)}return e}haveWinCondition(){if(!Array.isArray(this.solvedGrid))return!1;for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)if(!t(this.grid[e][i].conns,this.solvedGrid[e][i].conns))return!1;return this.won=!0,!0}pause(t){return this.timer.running?(this.timer.stop(t),!0):(this.timer.start(t),!1)}loadLevelString(t){let[e,i,s,n,r]=t.split(",");this.title=e,this.width=parseInt(i),this.height=parseInt(s),this.grid=this.newGridFromPuzstr(n),this.solvedGrid=this.newGridFromPuzstr(r)}xyFromPixelCoords(t,e){let i=Math.floor(e/this.tileVO),s=e%this.tileVO/this.tileVO,n=0;i%2==1&&(n=this.tileW/2);let r=Math.floor((t-n)/this.tileW),h=(t-n)%this.tileW/this.tileW;if(s<1/3){let t=3*s;h<.5?2*h<1-t&&(i%2==0&&(r-=1),i-=1):2*(h-.5)>t&&(i%2==0&&(r-=1),i-=1,r+=1)}return[r,i]}inBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}invertAngle(t){return t>2?t-3:t+3}xyAtAngle(t,e,i){let s=t,n=e;return 0==i?s++:1==i?(e%2==0||s++,n++):2==i?e%2==0?(s--,n++):n++:3==i?s--:4==i?e%2==0?(s--,n--):n--:5==i&&(e%2==0||s++,n--),s<0||s>this.width-1||n<0||n>this.height-1?null:[s,n]}isIsolated(t,e){for(let i=0;i<6;i++){if(!this.grid[e][t].conns[i])continue;let s=this.xyAtAngle(t,e,i);if(null==s)continue;let[n,r]=s;if(this.grid[r][n].conns[this.invertAngle(i)])return!1}return!0}getSurroundingTiles(t,e){let i=[];for(let s=0;s<6;s++){let n=this.xyAtAngle(t,e,s);if(null==n)continue;let[r,h]=n;i.push([r,h])}return i}getConnectedTiles(t,e,i){class s{constructor(t,e,i,s){this.x=t,this.y=e,this.fromangle=i,this.angle=s}}let n=[new s(t,e,null,0)],r=new Set;r.add(e*this.width+t);let h=new Set;for(;n.length>0;){let t=n.pop(),e=t.x,a=t.y,o=t.fromangle,l=t.angle;if(l>5)continue;if(n.push(new s(e,a,o,l+1)),null!=o&&o==l)continue;if(!this.grid[a][e].conns[l])continue;let d=this.xyAtAngle(e,a,l);if(null==d)continue;let[c,g]=d;if(this.grid[g][c].conns[this.invertAngle(l)])if(r.has(g*this.width+c)){let t=0;for(t=0;t<n.length&&(n[t].x!=c||n[t].y!=g);t++);if(t==n.length);else for(let e=t;e<n.length;e++)h.add(n[e].y*this.width+n[e].x)}else r.add(g*this.width+c),i&&n.push(new s(c,g,this.invertAngle(l),0))}return[r,h]}}function l(t,e){return e instanceof Map?{dataType:"Map",val:Array.from(e.entries())}:e}function d(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.val):e}const c={save:function(t,e){localStorage.setItem("phex_"+t,e)},saveInt:function(t,e){this.save(t,e)},saveStr:function(t,e){this.save(t,e)},saveMap:function(t,e){localStorage.setItem("phex_"+t,JSON.stringify(e,l))},loadMap:function(t,e){var i=localStorage.getItem("phex_"+t);return null==i?e:JSON.parse(i,d)},loadInt:function(t,e){var i=parseInt(localStorage.getItem("phex_"+t));return isNaN(i)?e:i},loadStr:function(t,e){let i=localStorage.getItem("phex_"+t);return null==i?e:i},saveObj:function(t,e){localStorage.setItem("phex_"+t,JSON.stringify(e))},loadObj:function(t,e){var i=localStorage.getItem("phex_"+t);return null==i?e:JSON.parse(i)}},g=["#d99a94","#da9d80","#d4a46e","#cbab5d","#bfb351","#b5b94e","#a6bf5a","#92c477","#83c596","#7ec4a5","#79c3b6","#77c0c8","#7dbbd8","#89b4e1","#9aade4","#aea4e2","#bc9fd8","#ca9ac8","#cf98bf","#d798a4"],u=20,m=["#a7a7a7","#555555","#333333","#000000"];class p{constructor(t,e){this.gameWidth=t,this.gameHeight=e,this.container=document.getElementById("container"),this.drawMethod=1,this.alwaysRenderAll=0,this.canvasCache=new Map,this.unitOnScreenH=64,this.unitOnScreenVO=48,this.unitOnScreenW=56,this.setUp(t,e)}setUp(t,e){console.log("setting up...");let{width:i,height:s}=this.container.getBoundingClientRect();s=document.documentElement.clientHeight-15,64!=this.srcBlockH&&(this.srcBlockH=64,this.srcBlockW=56);const[n]=this.container.children;n&&this.container.removeChild(n);const r=document.createElement("canvas");this.container.appendChild(r),this.context=r.getContext("2d"),r.setAttribute("width",""+(t*this.unitOnScreenW+Math.floor(this.unitOnScreenW/2))),r.setAttribute("height",""+((e+1)*this.unitOnScreenVO-this.unitOnScreenH/2)),this.renderStats()}renderImg(t,e,i,s){}renderFromCanvas(t,e,i){i%2==1&&(e+=.5),this.context&&this.context.drawImage(t,0,0,this.unitOnScreenW,this.unitOnScreenH,Math.floor(this.unitOnScreenW*e),this.unitOnScreenVO*i,this.unitOnScreenW,this.unitOnScreenH)}getHexCanvas(t=u+2){const e=t+65536;if(this.canvasCache.has(e))return this.canvasCache.get(e);let i=document.createElement("canvas"),s=i.getContext("2d"),n=this.unitOnScreenW,r=this.unitOnScreenH;return i.setAttribute("width",n.toString()),i.setAttribute("height",r.toString()),s.clearRect(0,0,n,r),s.fillStyle=t>=u?m[t-u]:g[t],s.strokeStyle=m[3],s.lineWidth=1,s.beginPath(),s.moveTo(n/2,0),s.lineTo(n,r/4),s.lineTo(n,3*r/4),s.lineTo(n/2,r),s.lineTo(0,3*r/4),s.lineTo(0,r/4),s.lineTo(n/2,0),s.fill(),s.stroke(),this.canvasCache.set(e,i),i}getLineCanvas(t,e){let i=0;for(let e=0;e<6;e++)t[e]&&(i|=1<<e);if(i|=e<<6,this.canvasCache.has(i))return this.canvasCache.get(i);let s=document.createElement("canvas"),n=s.getContext("2d"),r=this.unitOnScreenW,h=this.unitOnScreenH;s.setAttribute("width",r.toString()),s.setAttribute("height",h.toString()),n.lineCap="butt",n.lineJoin="bevel",n.clearRect(0,0,r,h),e>=u?(n.fillStyle=m[e-u],n.strokeStyle=m[e-u]):(n.fillStyle=g[e],n.strokeStyle=g[e]),n.lineWidth=h/8;let a=0;for(let e=0;e<t.length;e++){if(!t[e])continue;a++,n.beginPath(),n.moveTo(r/2,h/2);let i=r/2,s=h/2;0==e?i=r:1==e?(s=7*h/8,i=3*r/4):2==e?(s=7*h/8,i=1*r/4):3==e?i=0:4==e?(s=1*h/8,i=1*r/4):5==e&&(s=1*h/8,i=3*r/4),n.lineTo(i,s),n.stroke()}let o=h/16;return 1==a&&(o=h/8),n.beginPath(),n.moveTo(r/2,h/2),n.arc(r/2,h/2,o,0,2*Math.PI,!0),n.fill(),this.canvasCache.set(i,s),s}renderStats(){if(w&&w.stats){const t=w.stats;document.getElementById("stats_size").innerHTML=t.puztype,document.getElementById("stats_num").innerHTML=t.num,document.getElementById("stats_best").innerHTML=t.best,document.getElementById("stats_best3").innerHTML=t.best3,document.getElementById("stats_best5").innerHTML=t.best5,document.getElementById("stats_best10").innerHTML=t.best10}}render(){let t=w;if(!t)return void console.log("view::render() called with no gamemanager initialised");if(!this.context)return;let e=w.game,i=w.game.ts;(this.alwaysRenderAll||t.game.winningAnimation.started)&&t.paintAll();for(const s of t.renderSet){const[n,r]=t.game.xyFromIdx(s);if(0==this.drawMethod)this.renderImg(n,r,0,0),this.renderImg(n,r,e.grid[r][n].angle,e.grid[r][n].shape);else if(1==this.drawMethod){let h=null;if(t.game.winningAnimation.started){let e=Math.floor((i-t.game.winningAnimation.start_ts)/100)+n;e=Math.floor(e)%g.length,h=this.getHexCanvas(e)}else h=t.loopedSet.has(s)?this.getHexCanvas(u+1):this.getHexCanvas(u+2);this.renderFromCanvas(h,n,r);let a=t.game.grid[r][n].color,o=this.getLineCanvas(e.grid[r][n].conns,a);this.renderFromCanvas(o,n,r)}}if(t.renderSet.clear(),w.showFPS){let t=Math.floor(1e3/(i-e.tsPrior));document.getElementById("fps_text").innerHTML=""+t}e.tsPrior=i,document.getElementById("puzzle_title").innerHTML=e.title,document.getElementById("timer_text").innerHTML=e.timer.timestring(),e.won?(document.getElementById("wintime").innerHTML=e.wintime,document.getElementById("winner").classList.remove("hide"),this.renderStats()):document.getElementById("winner").classList.add("hide");const s=!w.game.timer.running;document.getElementById("pause").setAttribute("aria-pressed",s.toString())}}function f(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="text",i.onload=function(s){const n=i.response;console.log("puzzle file loaded: ",t);let r=[],h=n.split("\n");for(let t of h)t.length>8&&r.push(t);e(r)},i.send(null)}var w=new class{constructor(){this.PUZZLES=new Map,this.puzzleType=c.loadStr("puzzleType","5"),this.puzzleIdx=c.loadInt("puzzleIdx"+this.puzzleType,0),this.showStats=!1,this.showFPS=!1,this.showTimer=!0,this.showSettings=!1,f("/puzzles5.csv",(t=>this.PUZZLES.set("5",t))),f("/puzzles10.csv",(t=>this.PUZZLES.set("10",t))),f("/puzzles15.csv",(t=>this.PUZZLES.set("15",t))),f("/puzzles20.csv",(t=>this.PUZZLES.set("20",t))),f("/puzzles30.csv",(t=>this.PUZZLES.set("30",t))),f("/puzzles40.csv",(t=>this.PUZZLES.set("40",t))),this.renderSet=new Set,this.loopedSet=new Set,this.game=this.loadGame(parseInt(this.puzzleType)),this.updateStats(),this.view=new p(this.game.width,this.game.height),this.restart({restartSolved:!1,restartGame:!1}),this.view.container.addEventListener("contextmenu",(function(t){return t.preventDefault(),!1})),this.view.container.addEventListener("click",(function(t){return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1})),this.view.container.addEventListener("mouseup",(function(t){return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1})),this.view.container.addEventListener("mousedown",(function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();var e=w,[i,s]=e.game.xyFromPixelCoords(t.offsetX,t.offsetY);return e.game.inBounds(i,s)&&e.click(i,s,t.buttons),!1}))}prevPuzzle(){this.puzzleIdx<=0?console.log("No previous puzzles!"):(this.puzzleIdx--,c.saveInt("puzzleIdx"+this.puzzleType,this.puzzleIdx),this.restart())}nextPuzzle(){this.puzzleIdx+1>=this.PUZZLES.get(this.puzzleType).length?console.log("Ran out of puzzles!"):(this.puzzleIdx++,c.saveInt("puzzleIdx"+this.puzzleType,this.puzzleIdx),this.restart())}restart({restartSolved:t=!1,restartGame:e=!0}={}){if(this.PUZZLES.has(this.puzzleType)){if(e||0==this.game.width){const t=parseInt(this.puzzleType);this.game=new o({width:t,height:t}),this.game.loadLevelString(this.PUZZLES.get(this.puzzleType)[this.puzzleIdx])}if(!t){let t=c.loadMap("highscore"+this.puzzleType,new Map),e=parseInt(t.get(this.puzzleIdx));Number.isInteger(e)&&(this.game.grid=this.game.solvedGrid,this.game.timer=new a({time:e}),this.game.haveWinCondition()&&this.onWin())}this.view&&(this.view.setUp(this.game.width,this.game.height),this.paintAll()),this.saveGame()}else setTimeout((()=>w.restart({restartSolved:t,restartGame:e})),100)}setSize(t){this.puzzleType=t.toString(),c.saveStr("puzzleType",this.puzzleType),this.puzzleIdx=c.loadInt("puzzleIdx"+this.puzzleType,0),this.updateStats(),this.restart()}updateLoopSet(){const t=this.loopedSet;this.loopedSet=new Set;let e=[];for(let t=0;t<this.game.height*this.game.width;t++)e.push(t);for(;e.length>0;){let t=e.pop();if(-1==t)continue;let[i,s]=this.game.xyFromIdx(t),[n,r]=this.game.getConnectedTiles(i,s,!0);for(const t of n){let i=e.findIndex((e=>e===t));-1!=i&&(e[i]=-1)}for(const t of r)this.loopedSet.add(t)}for(const e of t)this.loopedSet.has(e)||this.renderSet.add(e);for(const e of this.loopedSet)t.has(e)||this.renderSet.add(e)}render(t){this.game.ts=t,this.game.timer.update(t),this.renderSet.size>0&&this.updateLoopSet(),this.view.render()}paintAll(){this.renderSet=new Set,this.loopedSet=new Set,this.updateLoopSet();for(let t=0;t<this.game.height*this.game.width;t++)this.renderSet.add(t)}saveGame(){c.saveObj("savegame",this.game)}loadGame(t){let e=c.loadObj("savegame",{width:0,height:0});return new o(e)}updateStats(){let t=[...c.loadMap("highscore"+this.puzzleType,new Map).values()];t.sort(((t,e)=>t-e));let e=this.puzzleType+"x"+this.puzzleType,i="tbd",s="tbd",n="tbd",r="tbd";t.length>=1&&(i=h(t[0])),t.length>=3&&(s=h(t.slice(0,3).reduce(((t,e)=>t+e),0)/3)),t.length>=5&&(n=h(t.slice(0,5).reduce(((t,e)=>t+e),0)/5)),t.length>=10&&(r=h(t.slice(0,10).reduce(((t,e)=>t+e),0)/10)),this.stats={puztype:e,num:t.length.toString(),best:i,best3:s,best5:n,best10:r}}onWin(){this.game.timer.stop(this.game.tsPrior),this.game.wintime=this.game.timer.timestring(),document.getElementById("wintime").innerHTML=this.game.wintime;let t=c.loadMap("highscore"+this.puzzleType,new Map);t.set(this.puzzleIdx,Math.trunc(this.game.timer.getMillis())),c.saveMap("highscore"+this.puzzleType,t),this.updateStats(),0==this.game.winningAnimation.started&&(this.game.winningAnimation.started=!0,this.game.winningAnimation.start_ts=this.game.ts)}click(t,e,i){if(!this.game.won){0==i||1==i?this.game.grid[e][t].rotate():2==i&&this.game.grid[e][t].rotate(!0),this.renderSet.add(this.game.idxFromXy(t,e)),this.game.timer.start(this.game.tsPrior);let s=this.game.getSurroundingTiles(t,e);for(;s.length>0;){let[t,e]=s.pop();this.game.isIsolated(t,e)?0==this.game.grid[e][t].isolated&&(this.game.grid[e][t].isolated=!0,this.game.grid[e][t].color=u,this.renderSet.add(this.game.idxFromXy(t,e))):1==this.game.grid[e][t].isolated&&(this.renderSet.add(this.game.idxFromXy(t,e)),this.game.grid[e][t].isolated=!1)}let[n,r]=this.game.getConnectedTiles(t,e,!0),h=this.game.grid[e][t].color;if(n.size<=1)this.game.grid[e][t].isolated=!0,h=u;else{this.game.grid[e][t].isolated=!1;let i=n.values();i.next();let s=i.next().value;h=this.game.tileFromIdx(s).color,h==u&&(h=(e*this.game.width+t)%g.length)}for(let t of n){let e=Math.trunc(t/this.game.width),i=t%this.game.width;this.game.grid[e][i].color!=h&&(this.game.grid[e][i].color=h,this.renderSet.add(t))}this.game.haveWinCondition()&&this.onWin()}this.render(this.game.ts),this.saveGame()}};document.getElementById("restart_button").addEventListener("click",(function(){w.restart({restartSolved:!0})})),document.getElementById("prev_puzzle").addEventListener("click",(function(){w.prevPuzzle()}));let S=document.getElementsByClassName("next_puzzle");for(let t=0;t<S.length;t++)S.item(t).addEventListener("click",(function(){w.nextPuzzle()}));function z(t,e){t instanceof HTMLButtonElement&&t.setAttribute("aria-pressed",e.toString())}function v(t,e){e?t.classList.remove("hide"):t.classList.add("hide")}document.getElementById("pause").addEventListener("click",(function(t){const e=w.game.pause(w.game.tsPrior);z(t.target,e)})),document.getElementById("show_fps").addEventListener("click",(function(t){w.showFPS=!w.showFPS;const e=w.showFPS;let i=document.getElementById("menu_fps");z(t.target,e),v(i,e)})),document.getElementById("show_timer").addEventListener("click",(function(t){w.showTimer=!w.showTimer;const e=w.showTimer;let i=document.getElementById("menu_time");z(t.target,e),v(i,e)})),document.getElementById("settings_button").addEventListener("click",(function(t){w.showSettings=!w.showSettings;const e=w.showSettings;let i=document.getElementById("settings_menu");z(t.target,e),v(i,e)})),document.getElementById("stats_button").addEventListener("click",(function(t){w.showStats=!w.showStats;const e=w.showStats;let i=document.getElementById("stats");z(t.target,e),v(i,e)}));let y=document.getElementById("settings_game_size");Array.prototype.forEach.call(y.children,(t=>{t.addEventListener("click",(function(e){const i=Number.parseInt(t.getAttribute("data"));w.setSize(i)}))})),function t(e){window.requestAnimationFrame(t),w.render(e)}(0)})();